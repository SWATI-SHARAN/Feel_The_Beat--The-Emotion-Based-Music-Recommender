<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feel The Beat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #ff4d94;
      --secondary: #4d79ff;
      --tertiary: #4dffdf;
      --dark: #0f0c24;
      --darker: #070518;
      --card-bg: rgba(15, 12, 36, 0.7);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--darker), var(--dark));
      color: white;
      overflow-x: hidden;
      position: relative;
    }

    .cosmos {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle var(--duration, 5s) infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .nebula {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.3;
      z-index: -1;
    }

    .floating {
      position: absolute;
      animation: float 25s infinite ease-in-out;
      opacity: 0.8;
      filter: blur(2px);
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(20px, 40px) rotate(5deg); }
      50% { transform: translate(-30px, 70px) rotate(-5deg); }
      75% { transform: translate(10px, 30px) rotate(3deg); }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 10;
    }

    header {
      text-align: center;
      padding: 30px 0;
      margin-bottom: 20px;
      position: relative;
    }

    h1 {
      font-size: 3.5rem;
      margin-bottom: 10px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--tertiary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 20px rgba(255, 77, 148, 0.3);
      letter-spacing: 2px;
    }

    .subtitle {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.7);
      max-width: 600px;
      margin: 0 auto 30px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: all 0.4s ease;
    }

    .panel:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(77, 121, 255, 0.2);
      border-color: rgba(77, 121, 255, 0.3);
    }

    .panel-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.8rem;
      margin-bottom: 20px;
      color: var(--tertiary);
    }

    .panel-title i {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .camera-container {
      position: relative;
      width: 100%;
      height: 300px;
      border-radius: 15px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .emotion-display {
      text-align: center;
      font-size: 1.8rem;
      margin: 20px 0;
      min-height: 60px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .emotion-value {
      font-weight: bold;
      text-transform: capitalize;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-size: 2rem;
    }

    .emotion-icon {
      font-size: 2.5rem;
    }

    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 25px 0;
      justify-content: center;
    }

    button {
      padding: 14px 28px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 5px 15px rgba(255, 77, 148, 0.3);
    }

    button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 20px rgba(77, 121, 255, 0.4);
    }

    button:active {
      transform: translateY(1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .language-selector {
      margin: 20px 0;
    }

    select {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 1rem;
      margin-top: 8px;
    }

    select:focus {
      outline: none;
      border-color: var(--tertiary);
    }

    .visualizer {
      display: flex;
      height: 100px;
      align-items: flex-end;
      justify-content: center;
      gap: 4px;
      margin: 20px 0;
    }

    .bar {
      width: 10px;
      background: linear-gradient(to top, var(--primary), var(--secondary));
      border-radius: 5px 5px 0 0;
      animation: dance 1.5s infinite ease-in-out;
      animation-delay: calc(var(--i) * 0.1s);
    }

    @keyframes dance {
      0%, 100% { height: 20%; }
      50% { height: 90%; }
    }

    .song-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .song-list::-webkit-scrollbar {
      width: 8px;
    }

    .song-list::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .song-list::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    .track {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: 15px;
      background: rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      gap: 15px;
    }

    .track:hover {
      background: rgba(77, 121, 255, 0.15);
      transform: translateX(5px);
    }

    .track img {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .track-info {
      flex-grow: 1;
    }

    .track h3 {
      margin-bottom: 5px;
      font-size: 1.1rem;
    }

    .track p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
    }

    .track-actions {
      display: flex;
      gap: 10px;
    }

    .track-actions button {
      padding: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .favorites-panel {
      margin-top: 40px;
    }

    .favorites-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .favorite-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
      border: 1px solid rgba(77, 121, 255, 0.1);
    }

    .favorite-card:hover {
      transform: translateY(-5px);
      border-color: rgba(77, 121, 255, 0.3);
    }

    .favorite-card img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .status {
      text-align: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      margin: 20px 0;
    }

    .loading {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(77, 121, 255, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(77, 121, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(77, 121, 255, 0); }
    }

    footer {
      text-align: center;
      padding: 30px 0;
      margin-top: 40px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .emotion-illustration {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .emoji-face {
      font-size: 5rem;
      transition: transform 0.5s ease;
    }
  </style>
</head>
<body>
  <!-- Cosmic background elements -->
  <div class="cosmos" id="cosmos"></div>
  
  <div class="container">
    <header>
      <h1><i class="fas fa-stars"></i> FEEL THE BEAT!</h1>
      <p class="subtitle">Your emotions shape the music. Experience real-time emotion detection with personalized cosmic soundscapes.</p>
    </header>
    
    <div class="main-content">
      <div class="panel">
        <h2 class="panel-title"><i class="fas fa-camera"></i> Emotion Detection</h2>
        
        <div class="camera-container">
          <video id="video" autoplay muted playsinline></video>
          <canvas id="canvas"></canvas>
          <div class="status" id="camera-status">
            <div class="loading"></div> Loading camera...
          </div>
        </div>
        
        <div class="emotion-illustration">
          <div class="emoji-face" id="emoji-face">üòê</div>
        </div>
        
        <div class="emotion-display">
          <span>Current Emotion:</span>
          <span class="emotion-value" id="emotion-text">neutral</span>
        </div>
        
        <div class="visualizer" id="visualizer">
          <!-- Audio visualizer bars will be generated here -->
        </div>
        
        <div class="controls">
          <button id="start-btn" class="pulse">
            <i class="fas fa-play"></i> Start Detection
          </button>
          <button id="stop-btn" disabled>
            <i class="fas fa-stop"></i> Pause
          </button>
        </div>
        
        <div class="language-selector">
          <label>Music Language:</label>
          <select id="language-select">
            <option value="all">Universal Vibes</option>
            <option value="english">English</option>
            <option value="hindi">Hindi</option>
            <option value="spanish">Spanish</option>
            <option value="korean">Korean</option>
            <option value="french">French</option>
            <option value="japanese">Japanese</option>
          </select>
        </div>
        
        <div class="controls">
          <button id="detect-happy">
            <i class="fas fa-smile"></i> Happy
          </button>
          <button id="detect-sad">
            <i class="fas fa-sad-tear"></i> Sad
          </button>
          <button id="detect-angry">
            <i class="fas fa-angry"></i> Angry
          </button>
          <button id="detect-neutral">
            <i class="fas fa-meh"></i> Neutral
          </button>
        </div>
      </div>
      
      <div class="panel">
        <h2 class="panel-title"><i class="fas fa-music"></i> Cosmic Recommendations</h2>
        
        <div class="status" id="status">
          <div class="loading"></div> Waiting for your emotions to guide the music...
        </div>
        
        <div class="song-list" id="song-list">
          <!-- Song list will be populated here -->
        </div>
      </div>
    </div>
    
    <div class="panel favorites-panel">
      <h2 class="panel-title"><i class="fas fa-heart"></i> Stellar Favorites</h2>
      <div class="favorites-grid" id="favorites-list">
        <!-- Favorites will be populated here -->
      </div>
    </div>
    
    <footer>
      <p>FEEL THE BEAT - Emotion Player ‚Ä¢ Feel the universe through music</p>
      <p>Your emotions create unique cosmic soundscapes in real-time</p>
    </footer>
  </div>
  
  <audio id="preview-player" hidden></audio>
  
  <script>
    // Create cosmic background
    function createCosmos() {
      const cosmos = document.getElementById('cosmos');
      
      // Create stars
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        star.style.width = `${Math.random() * 3}px`;
        star.style.height = star.style.width;
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.setProperty('--duration', `${Math.random() * 10 + 5}s`);
        cosmos.appendChild(star);
      }
      
      // Create nebulas
      for (let i = 0; i < 4; i++) {
        const nebula = document.createElement('div');
        nebula.classList.add('nebula');
        nebula.style.width = `${Math.random() * 300 + 200}px`;
        nebula.style.height = nebula.style.width;
        nebula.style.left = `${Math.random() * 100}%`;
        nebula.style.top = `${Math.random() * 100}%`;
        nebula.style.background = `radial-gradient(circle, 
          ${i % 2 === 0 ? 'rgba(255, 77, 148, 0.5)' : 'rgba(77, 121, 255, 0.5)'}, 
          transparent 70%)`;
        cosmos.appendChild(nebula);
      }
      
      // Create floating shapes
      for (let i = 0; i < 8; i++) {
        const shape = document.createElement('div');
        shape.classList.add('floating');
        shape.style.width = `${Math.random() * 100 + 50}px`;
        shape.style.height = shape.style.width;
        shape.style.left = `${Math.random() * 100}%`;
        shape.style.top = `${Math.random() * 100}%`;
        shape.style.background = `conic-gradient(
          from ${Math.random() * 360}deg,
          rgba(255, 77, 148, 0.3),
          rgba(77, 121, 255, 0.3),
          rgba(77, 255, 223, 0.3),
          rgba(255, 77, 148, 0.3)
        )`;
        shape.style.borderRadius = `${Math.random() * 50}%`;
        shape.style.animationDuration = `${Math.random() * 20 + 20}s`;
        cosmos.appendChild(shape);
      }
    }
    
    // Create audio visualizer
    function createVisualizer() {
      const visualizer = document.getElementById('visualizer');
      visualizer.innerHTML = '';
      
      for (let i = 0; i < 30; i++) {
        const bar = document.createElement('div');
        bar.classList.add('bar');
        bar.style.setProperty('--i', i);
        bar.style.height = `${Math.random() * 50 + 10}%`;
        visualizer.appendChild(bar);
      }
    }
    
    // Emotion to emoji mapping
    const emotionEmoji = {
      happy: 'üòä',
      sad: 'üò¢',
      angry: 'üò†',
      fearful: 'üò®',
      disgusted: 'ü§¢',
      surprised: 'üò≤',
      neutral: 'üòê'
    };
    
    // Emotion to Spotify search term mapping
    const emotionSearchTerms = {
      happy: 'upbeat joyful',
      sad: 'melancholic emotional',
      angry: 'intense aggressive',
      fearful: 'atmospheric ambient',
      disgusted: 'experimental avant-garde',
      surprised: 'energetic surprising',
      neutral: 'chill relaxing'
    };
    
    // Sample music data for demo
    const sampleMusicData = {
      happy: [
        { id: '1', name: 'Sunshine Day', artist: 'Solar Beats', album: 'Radiant Vibes', image: 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '2', name: 'Dancing in the Stars', artist: 'Cosmic Crew', album: 'Galaxy Grooves', image: 'https://images.unsplash.com/photo-1459749411175-04bf5292ceea?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '3', name: 'Joyful Journey', artist: 'Orion Orchestra', album: 'Celestial Happiness', image: 'https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '4', name: 'Euphoric Energy', artist: 'Nova Notes', album: 'Stellar Sounds', image: 'https://images.unsplash.com/photo-1485579149621-3123dd979885?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' }
      ],
      sad: [
        { id: '5', name: 'Melancholy Moon', artist: 'Lunar Souls', album: 'Midnight Tears', image: 'https://images.unsplash.com/photo-1494232410401-ad00d5433cfa?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '6', name: 'Rainy Nebula', artist: 'Cosmic Rain', album: 'Distant Sorrow', image: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '7', name: 'Lonely Orbit', artist: 'Solitary Stars', album: 'Isolated Universe', image: 'https://images.unsplash.com/photo-1429962714451-bb934ecdc4ec?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '8', name: 'Echoes of Emptiness', artist: 'Void Voices', album: 'Silent Space', image: 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' }
      ],
      angry: [
        { id: '9', name: 'Raging Supernova', artist: 'Fury Fusion', album: 'Explosive Energy', image: 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '10', name: 'Thunderous Black Hole', artist: 'Storm System', album: 'Cosmic Chaos', image: 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '11', name: 'Volcanic Vortex', artist: 'Magma Melodies', album: 'Erupting Emotions', image: 'https://images.unsplash.com/photo-1468164016595-6108e4c60c8b?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '12', name: 'Collision Course', artist: 'Impact Ensemble', album: 'Celestial Clash', image: 'https://images.unsplash.com/photo-1459231978203-b7d0c47a2cb7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' }
      ],
      neutral: [
        { id: '13', name: 'Calm Cosmos', artist: 'Space Serenity', album: 'Peaceful Planets', image: 'https://images.unsplash.com/photo-1451188502541-13943edb6acb?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '14', name: 'Drifting Through Space', artist: 'Orbital Oasis', album: 'Floating Harmonies', image: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '15', name: 'Quasar Quiet', artist: 'Distant Harmony', album: 'Tranquil Travels', image: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' },
        { id: '16', name: 'Meditation Meteor', artist: 'Zenith Zephyr', album: 'Mindful Milky Way', image: 'https://images.unsplash.com/photo-1446776899648-aa78eefe8ed0?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400&q=80' }
      ]
    };
    
    // Initialize the application
    async function initApp() {
      createCosmos();
      createVisualizer();
      setupEventListeners();
      renderFavorites();
      
      // Set initial emotion
      updateEmotionDisplay('neutral');
      
      // Setup camera
      await setupCamera();
      
      // Load face-api models
      await loadFaceModels();
    }
    
    // Setup camera
    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'user',
            width: { ideal: 640 },
            height: { ideal: 480 }
          } 
        });
        const video = document.getElementById('video');
        video.srcObject = stream;
        
        // Hide loading message
        document.getElementById('camera-status').style.display = 'none';
        
        return new Promise(resolve => {
          video.onloadedmetadata = () => {
            resolve(video);
          };
        });
      } catch (err) {
        console.error('Camera error:', err);
        document.getElementById('camera-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Could not access camera. Please enable permissions.';
        return null;
      }
    }
    
    // Load face-api models
    async function loadFaceModels() {
      // Load models from CDN
      const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
      
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
      await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
    }
    
    // Update emotion display
    function updateEmotionDisplay(emotion) {
      document.getElementById('emotion-text').textContent = emotion;
      document.getElementById('emoji-face').textContent = emotionEmoji[emotion] || 'ü§î';
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Emotion buttons
      document.getElementById('detect-happy').addEventListener('click', () => {
        updateEmotionDisplay('happy');
        updateSongsForEmotion('happy');
      });
      
      document.getElementById('detect-sad').addEventListener('click', () => {
        updateEmotionDisplay('sad');
        updateSongsForEmotion('sad');
      });
      
      document.getElementById('detect-angry').addEventListener('click', () => {
        updateEmotionDisplay('angry');
        updateSongsForEmotion('angry');
      });
      
      document.getElementById('detect-neutral').addEventListener('click', () => {
        updateEmotionDisplay('neutral');
        updateSongsForEmotion('neutral');
      });
      
      // Start/stop buttons
      document.getElementById('start-btn').addEventListener('click', () => {
        startDetection();
      });
      
      document.getElementById('stop-btn').addEventListener('click', () => {
        stopDetection();
      });
      
      // Language selector
      document.getElementById('language-select').addEventListener('change', () => {
        if (document.getElementById('emotion-text').textContent !== 'none') {
          updateSongsForEmotion(document.getElementById('emotion-text').textContent);
        }
      });
    }
    
    // Start detection
    function startDetection() {
      document.getElementById('start-btn').disabled = true;
      document.getElementById('stop-btn').disabled = false;
      
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size to match video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // Start detection loop
      const detectInterval = setInterval(async () => {
        if (document.getElementById('stop-btn').disabled) {
          clearInterval(detectInterval);
          return;
        }
        
        // Detect emotions
        const detections = await faceapi.detectSingleFace(
          video, 
          new faceapi.TinyFaceDetectorOptions()
        ).withFaceLandmarks().withFaceExpressions();
        
        if (detections) {
          // Draw detection on canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          faceapi.draw.drawDetections(canvas, detections);
          faceapi.draw.drawFaceLandmarks(canvas, detections);
          faceapi.draw.drawFaceExpressions(canvas, detections);
          
          // Get dominant emotion
          const expressions = detections.expressions;
          const emotion = Object.keys(expressions).reduce(
            (a, b) => expressions[a] > expressions[b] ? a : b
          );
          
          // Update UI
          updateEmotionDisplay(emotion);
          updateSongsForEmotion(emotion);
        }
      }, 1000);
      
      // Store interval ID to stop later
      window.detectInterval = detectInterval;
    }
    
    // Stop detection
    function stopDetection() {
      document.getElementById('start-btn').disabled = false;
      document.getElementById('stop-btn').disabled = true;
      
      // Clear detection interval
      if (window.detectInterval) {
        clearInterval(window.detectInterval);
      }
      
      // Clear canvas
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    // Update songs based on emotion
    function updateSongsForEmotion(emotion) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="loading"></div> Creating ${emotion} cosmic soundscape...`;
      
      setTimeout(() => {
        const songs = sampleMusicData[emotion] || sampleMusicData.neutral;
        renderSongList(songs);
        
        statusDiv.innerHTML = `<i class="fas fa-check"></i> Found ${songs.length} cosmic tracks for ${emotion}`;
      }, 1500);
    }
    
    // Render song list
    function renderSongList(tracks) {
      const songListDiv = document.getElementById('song-list');
      songListDiv.innerHTML = '';
      
      tracks.forEach(track => {
        const trackEl = document.createElement('div');
        trackEl.className = 'track';
        
        trackEl.innerHTML = `
          <img src="${track.image}" alt="${track.name}">
          <div class="track-info">
            <h3>${track.name}</h3>
            <p>${track.artist} ‚Ä¢ ${track.album}</p>
          </div>
          <div class="track-actions">
            <button class="play-btn">
              <i class="fas fa-play"></i>
            </button>
            <button class="favorite-btn">
              <i class="fas fa-heart"></i>
            </button>
          </div>
        `;
        
        songListDiv.appendChild(trackEl);
      });
      
      // Add event listeners
      document.querySelectorAll('.track .play-btn').forEach((btn, index) => {
        btn.addEventListener('click', () => {
          const player = document.getElementById('preview-player');
          player.play();
          animateVisualizer();
        });
      });
      
      document.querySelectorAll('.track .favorite-btn').forEach((btn, index) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const track = tracks[index];
          addToFavorites(track);
          btn.innerHTML = '<i class="fas fa-check"></i>';
          setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-heart"></i>';
          }, 1000);
        });
      });
    }
    
    // Add to favorites
    function addToFavorites(track) {
      const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      
      // Check if already in favorites
      if (!favorites.some(fav => fav.id === track.id)) {
        favorites.push(track);
        localStorage.setItem('favorites', JSON.stringify(favorites));
        renderFavorites();
      }
    }
    
    // Render favorites
    function renderFavorites() {
      const favoritesListDiv = document.getElementById('favorites-list');
      favoritesListDiv.innerHTML = '';
      
      const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      
      if (favorites.length === 0) {
        favoritesListDiv.innerHTML = `
          <div class="status">
            <i class="fas fa-star"></i> No favorites yet. Add some tracks to your stellar collection!
          </div>
        `;
        return;
      }
      
      favorites.forEach(track => {
        const card = document.createElement('div');
        card.className = 'favorite-card';
        
        card.innerHTML = `
          <img src="${track.image}" alt="${track.name}">
          <h3>${track.name}</h3>
          <p>${track.artist}</p>
          <div class="track-actions" style="margin-top: 15px;">
            <button class="play-btn">
              <i class="fas fa-play"></i>
            </button>
            <button class="favorite-btn">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        favoritesListDiv.appendChild(card);
      });
      
      // Add event listeners to favorites
      document.querySelectorAll('.favorite-card .play-btn').forEach((btn, index) => {
        btn.addEventListener('click', () => {
          animateVisualizer();
        });
      });
      
      document.querySelectorAll('.favorite-card .favorite-btn').forEach((btn, index) => {
        btn.addEventListener('click', () => {
          const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
          favorites.splice(index, 1);
          localStorage.setItem('favorites', JSON.stringify(favorites));
          renderFavorites();
        });
      });
    }
    
    // Animate visualizer when playing
    function animateVisualizer() {
      const bars = document.querySelectorAll('.bar');
      bars.forEach(bar => {
        bar.style.animation = 'none';
        setTimeout(() => {
          bar.style.animation = '';
        }, 10);
      });
    }
    
    // Initialize the app when the page loads
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>