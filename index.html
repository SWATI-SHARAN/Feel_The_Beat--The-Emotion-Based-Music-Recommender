<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feel The Beat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #ff4d94;
      --secondary: #4d79ff;
      --tertiary: #4dffdf;
      --dark: #0f0c24;
      --darker: #070518;
      --card-bg: rgba(15, 12, 36, 0.7);
      --spotify-green: #1DB954;
      --error-red: #ff3860;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--darker), var(--dark));
      color: white;
      overflow-x: hidden;
      position: relative;
    }

    .cosmos {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle var(--duration, 5s) infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .nebula {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.3;
      z-index: -1;
    }

    .floating {
      position: absolute;
      animation: float 25s infinite ease-in-out;
      opacity: 0.8;
      filter: blur(2px);
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(20px, 40px) rotate(5deg); }
      50% { transform: translate(-30px, 70px) rotate(-5deg); }
      75% { transform: translate(10px, 30px) rotate(3deg); }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 10;
    }

    header {
      text-align: center;
      padding: 30px 0;
      margin-bottom: 20px;
      position: relative;
    }

    h1 {
      font-size: 3.5rem;
      margin-bottom: 10px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--tertiary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 20px rgba(255, 77, 148, 0.3);
      letter-spacing: 2px;
    }

    .subtitle {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.7);
      max-width: 600px;
      margin: 0 auto 30px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: all 0.4s ease;
    }

    .panel:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(77, 121, 255, 0.2);
      border-color: rgba(77, 121, 255, 0.3);
    }

    .panel-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.8rem;
      margin-bottom: 20px;
      color: var(--tertiary);
    }

    .panel-title i {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .camera-container {
      position: relative;
      width: 100%;
      height: 300px;
      border-radius: 15px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .emotion-display {
      text-align: center;
      font-size: 1.8rem;
      margin: 20px 0;
      min-height: 60px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .emotion-value {
      font-weight: bold;
      text-transform: capitalize;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-size: 2rem;
    }

    .emotion-icon {
      font-size: 2.5rem;
    }

    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 25px 0;
      justify-content: center;
    }

    button {
      padding: 14px 28px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 5px 15px rgba(255, 77, 148, 0.3);
    }

    button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 20px rgba(77, 121, 255, 0.4);
    }

    button:active {
      transform: translateY(1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .language-selector {
      margin: 20px 0;
    }

    select {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 1rem;
      margin-top: 8px;
    }

    select:focus {
      outline: none;
      border-color: var(--tertiary);
    }

    .visualizer {
      display: flex;
      height: 100px;
      align-items: flex-end;
      justify-content: center;
      gap: 4px;
      margin: 20px 0;
    }

    .bar {
      width: 10px;
      background: linear-gradient(to top, var(--primary), var(--secondary));
      border-radius: 5px 5px 0 0;
      animation: dance 1.5s infinite ease-in-out;
      animation-delay: calc(var(--i) * 0.1s);
    }

    @keyframes dance {
      0%, 100% { height: 20%; }
      50% { height: 90%; }
    }

    .song-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .song-list::-webkit-scrollbar {
      width: 8px;
    }

    .song-list::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .song-list::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    .track {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: 15px;
      background: rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      gap: 15px;
      cursor: pointer;
    }

    .track:hover {
      background: rgba(77, 121, 255, 0.15);
      transform: translateX(5px);
    }

    .track img {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .track-info {
      flex-grow: 1;
    }

    .track h3 {
      margin-bottom: 5px;
      font-size: 1.1rem;
    }

    .track p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
    }

    .track-actions {
      display: flex;
      gap: 10px;
    }

    .track-actions button {
      padding: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .favorites-panel {
      margin-top: 40px;
    }

    .favorites-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .favorite-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
      border: 1px solid rgba(77, 121, 255, 0.1);
      cursor: pointer;
    }

    .favorite-card:hover {
      transform: translateY(-5px);
      border-color: rgba(77, 121, 255, 0.3);
      box-shadow: 0 10px 25px rgba(77, 121, 255, 0.2);
    }

    .favorite-card img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 15px;
      aspect-ratio: 1/1;
      object-fit: cover;
    }

    .status {
      text-align: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      margin: 20px 0;
    }

    .loading {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(77, 121, 255, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(77, 121, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(77, 121, 255, 0); }
    }

    footer {
      text-align: center;
      padding: 30px 0;
      margin-top: 40px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .emotion-illustration {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .emoji-face {
      font-size: 5rem;
      transition: transform 0.5s ease;
    }
    
    .notification {
      position: fixed;
      top: 80px;
      right: 20px;
      background: var(--spotify-green);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      z-index: 1000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transform: translateX(120%);
      transition: transform 0.4s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background: var(--error-red);
    }
    
    .connection-status {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-connected {
      color: var(--tertiary);
    }
    
    .spotify-icon {
      color: var(--spotify-green);
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .feature-card {
      background: rgba(15, 12, 36, 0.5);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(77, 121, 255, 0.1);
    }
    
    .feature-card:hover {
      transform: translateY(-5px);
      border-color: var(--tertiary);
    }
    
    .feature-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .app-stats {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }
    
    .stat-card {
      background: rgba(15, 12, 36, 0.5);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      min-width: 120px;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .app-description {
      text-align: center;
      max-width: 800px;
      margin: 0 auto 40px;
      padding: 20px;
      background: rgba(15, 12, 36, 0.5);
      border-radius: 15px;
      border: 1px solid rgba(77, 121, 255, 0.2);
    }
    
    .guide-container {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      margin-top: 40px;
    }
    
    .guide-title {
      font-size: 1.8rem;
      margin-bottom: 20px;
      color: var(--tertiary);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .steps {
      counter-reset: step-counter;
      margin-left: 20px;
    }
    
    .step {
      position: relative;
      margin-bottom: 30px;
      padding-left: 50px;
    }
    
    .step:before {
      counter-increment: step-counter;
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .step-title {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: var(--tertiary);
    }
    
    .step-content {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
    }
    
    .backend-status {
      background: rgba(77, 121, 255, 0.15);
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .backend-connected {
      color: var(--tertiary);
    }
    
    .backend-disconnected {
      color: var(--error-red);
    }
  </style>
</head>
<body>
  <!-- Cosmic background elements -->
  <div class="cosmos" id="cosmos"></div>
  
  <div class="connection-status">
    <i class="fas fa-circle status-connected"></i>
    <span>Spotify Connected via Server</span>
  </div>
  
  <div class="container">
    <header>
      <h1><i class="fas fa-stars"></i> FEEL THE BEAT!</h1>
      <p class="subtitle">Your emotions shape the music. Experience real-time emotion detection with personalized cosmic soundscapes.</p>
      
      <div class="app-description">
        <p>Welcome to the Feel The Beat - an immersive experience that detects your emotions through facial recognition and plays music that matches your mood. Powered by Spotify's vast music library.</p>
      </div>
    </header>
    
    <div class="feature-grid">
      <div class="feature-card">
        <div class="feature-icon"><i class="fas fa-camera"></i></div>
        <h3>Real-time Emotion Detection</h3>
        <p>Advanced AI analyzes your facial expressions to detect your mood</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon"><i class="fas fa-heart"></i></div>
        <h3>Save Favorites</h3>
        <p>Save your favorite tracks to your stellar collection</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon"><i class="fas fa-globe"></i></div>
        <h3>Global Music</h3>
        <p>Discover music from different cultures and languages</p>
      </div>
    </div>
    
    <div class="main-content">
      <div class="panel">
        <h2 class="panel-title"><i class="fas fa-camera"></i> Emotion Detection</h2>
        
        <div class="camera-container">
          <video id="video" autoplay muted playsinline></video>
          <canvas id="canvas"></canvas>
          <div class="status" id="camera-status">
            <div class="loading"></div> Loading camera...
          </div>
        </div>
        
        <div class="emotion-illustration">
          <div class="emoji-face" id="emoji-face">üòê</div>
        </div>
        
        <div class="emotion-display">
          <span>Current Emotion:</span>
          <span class="emotion-value" id="emotion-text">neutral</span>
        </div>
        
        <div class="visualizer" id="visualizer">
          <!-- Audio visualizer bars will be generated here -->
        </div>
        
        <div class="controls">
          <button id="start-btn" class="pulse">
            <i class="fas fa-play"></i> Start Detection
          </button>
          <button id="stop-btn" disabled>
            <i class="fas fa-stop"></i> Pause
          </button>
        </div>
        
        <div class="language-selector">
          <label>Music Language:</label>
          <select id="language-select">
            <option value="all">Universal Vibes</option>
            <option value="english">English</option>
            <option value="hindi">Hindi</option>
            <option value="spanish">Spanish</option>
            <option value="korean">Korean</option>
            <option value="french">French</option>
            <option value="japanese">Japanese</option>
          </select>
        </div>
        
        <div class="controls">
          <button id="detect-happy">
            <i class="fas fa-smile"></i> Happy
          </button>
          <button id="detect-sad">
            <i class="fas fa-sad-tear"></i> Sad
          </button>
          <button id="detect-angry">
            <i class="fas fa-angry"></i> Angry
          </button>
          <button id="detect-neutral">
            <i class="fas fa-meh"></i> Neutral
          </button>
        </div>
      </div>
      
      <div class="panel">
        <h2 class="panel-title"><i class="fas fa-music"></i> Cosmic Recommendations</h2>
        
        <div class="backend-status">
          <i class="fas fa-server"></i>
          <span>Connected to Spotify backend server</span>
        </div>
        
        <div class="status" id="status">
          <div class="loading"></div> Waiting for your emotions to guide the music...
        </div>
        
        <div class="song-list" id="song-list">
          <!-- Song list will be populated here -->
        </div>
      </div>
    </div>
    
    <div class="panel favorites-panel">
      <h2 class="panel-title"><i class="fas fa-heart"></i> Stellar Favorites</h2>
      <div class="favorites-grid" id="favorites-list">
        <div class="status">
          <i class="fas fa-star"></i> No favorites yet. Add some tracks to your stellar collection!
        </div>
      </div>
    </div>
    
    <div class="app-stats">
      <div class="stat-card">
        <div class="stat-value">7</div>
        <div>Emotions Detected</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">50+</div>
        <div>Songs Available</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">7</div>
        <div>Languages Supported</div>
      </div>
    </div>
    
    <div class="guide-container">
      <h2 class="guide-title"><i class="fas fa-info-circle"></i> How to Use</h2>
      <div class="steps">
        <div class="step">
          <h3 class="step-title">1. Allow Camera Access</h3>
          <p class="step-content">Grant permission to access your camera for emotion detection.</p>
        </div>
        <div class="step">
          <h3 class="step-title">2. Detect Your Emotion</h3>
          <p class="step-content">Click "Start Detection" and let the AI analyze your facial expressions.</p>
        </div>
        <div class="step">
          <h3 class="step-title">3. Enjoy Cosmic Music</h3>
          <p class="step-content">Listen to music that matches your mood, and save your favorites!</p>
        </div>
      </div>
    </div>
    
    <footer>
      <p>Feel The Beat ‚Ä¢ Feel the universe through music</p>
      <p>Made With Love by Swati ‚ù§Ô∏è‚ú®</p>
    </footer>
  </div>

  <script>
    // Emotion to Spotify genre mapping
    const emotionToGenre = {
      happy: ['pop', 'dance', 'electronic', 'happy', 'summer', 'party'],
      sad: ['sad', 'blues', 'acoustic', 'emo', 'rainy-day', 'chill'],
      angry: ['rock', 'metal', 'punk', 'hard-rock', 'heavy-metal', 'hardcore'],
      fearful: ['ambient', 'soundtrack', 'dark-ambient', 'classical', 'meditation'],
      disgusted: ['experimental', 'avant-garde', 'noise', 'industrial', 'glitch'],
      surprised: ['edm', 'dubstep', 'drum-and-bass', 'electronic', 'techno'],
      neutral: ['chill', 'ambient', 'classical', 'new-age', 'jazz', 'lo-fi']
    };
    
    // Emotion to emoji mapping
    const emotionEmoji = {
      happy: 'üòä',
      sad: 'üò¢',
      angry: 'üò†',
      fearful: 'üò®',
      disgusted: 'ü§¢',
      surprised: 'üò≤',
      neutral: 'üòê'
    };
    
    // Create cosmic background
    function createCosmos() {
      const cosmos = document.getElementById('cosmos');
      if (!cosmos) return;
      
      cosmos.innerHTML = '';
      
      // Create stars
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        star.style.width = `${Math.random() * 3}px`;
        star.style.height = star.style.width;
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.setProperty('--duration', `${Math.random() * 10 + 5}s`);
        cosmos.appendChild(star);
      }
      
      // Create nebulas
      for (let i = 0; i < 4; i++) {
        const nebula = document.createElement('div');
        nebula.classList.add('nebula');
        nebula.style.width = `${Math.random() * 300 + 200}px`;
        nebula.style.height = nebula.style.width;
        nebula.style.left = `${Math.random() * 100}%`;
        nebula.style.top = `${Math.random() * 100}%`;
        nebula.style.background = `radial-gradient(circle, 
          ${i % 2 === 0 ? 'rgba(255, 77, 148, 0.5)' : 'rgba(77, 121, 255, 0.5)'}, 
          transparent 70%)`;
        cosmos.appendChild(nebula);
      }
      
      // Create floating shapes
      for (let i = 0; i < 8; i++) {
        const shape = document.createElement('div');
        shape.classList.add('floating');
        shape.style.width = `${Math.random() * 100 + 50}px`;
        shape.style.height = shape.style.width;
        shape.style.left = `${Math.random() * 100}%`;
        shape.style.top = `${Math.random() * 100}%`;
        shape.style.background = `conic-gradient(
          from ${Math.random() * 360}deg,
          rgba(255, 77, 148, 0.3),
          rgba(77, 121, 255, 0.3),
          rgba(77, 255, 223, 0.3),
          rgba(255, 77, 148, 0.3)
        )`;
        shape.style.borderRadius = `${Math.random() * 50}%`;
        shape.style.animationDuration = `${Math.random() * 20 + 20}s`;
        cosmos.appendChild(shape);
      }
    }
    
    // Create audio visualizer
    function createVisualizer() {
      const visualizer = document.getElementById('visualizer');
      if (!visualizer) return;
      
      visualizer.innerHTML = '';
      
      for (let i = 0; i < 30; i++) {
        const bar = document.createElement('div');
        bar.classList.add('bar');
        bar.style.setProperty('--i', i);
        bar.style.height = `${Math.random() * 50 + 10}%`;
        visualizer.appendChild(bar);
      }
    }
    
    // Show notification
    function showNotification(message, isSuccess = true) {
      const notification = document.createElement('div');
      notification.className = isSuccess ? 'notification show' : 'notification error show';
      notification.innerHTML = `
        <i class="fab fa-spotify"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 500);
      }, 3000);
    }
    
    // Initialize the application
    async function initApp() {
      createCosmos();
      createVisualizer();
      setupEventListeners();
      renderFavorites();
      
      // Set initial emotion
      updateEmotionDisplay('neutral');
      
      // Setup camera
      await setupCamera();
      
      // Load face-api models
      await loadFaceModels();
      
      // Load initial songs
      updateSongsForEmotion('neutral');
    }
    
    // Setup camera
    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'user',
            width: { ideal: 640 },
            height: { ideal: 480 }
          } 
        });
        const video = document.getElementById('video');
        if (!video) return;
        
        video.srcObject = stream;
        
        // Hide loading message
        const cameraStatus = document.getElementById('camera-status');
        if (cameraStatus) cameraStatus.style.display = 'none';
        
        return new Promise(resolve => {
          video.onloadedmetadata = () => {
            resolve(video);
          };
        });
      } catch (err) {
        console.error('Camera error:', err);
        const cameraStatus = document.getElementById('camera-status');
        if (cameraStatus) {
          cameraStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Could not access camera. Please enable permissions.';
        }
        return null;
      }
    }
    
    // Load face-api models
    async function loadFaceModels() {
      // Load models from CDN
      const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
      
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
      await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
    }
    
    // Update emotion display
    function updateEmotionDisplay(emotion) {
      const emotionText = document.getElementById('emotion-text');
      if (emotionText) emotionText.textContent = emotion;
      
      const emojiFace = document.getElementById('emoji-face');
      if (emojiFace) emojiFace.textContent = emotionEmoji[emotion] || 'ü§î';
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Emotion buttons
      const detectHappy = document.getElementById('detect-happy');
      if (detectHappy) {
        detectHappy.addEventListener('click', () => {
          updateEmotionDisplay('happy');
          updateSongsForEmotion('happy');
        });
      }
      
      const detectSad = document.getElementById('detect-sad');
      if (detectSad) {
        detectSad.addEventListener('click', () => {
          updateEmotionDisplay('sad');
          updateSongsForEmotion('sad');
        });
      }
      
      const detectAngry = document.getElementById('detect-angry');
      if (detectAngry) {
        detectAngry.addEventListener('click', () => {
          updateEmotionDisplay('angry');
          updateSongsForEmotion('angry');
        });
      }
      
      const detectNeutral = document.getElementById('detect-neutral');
      if (detectNeutral) {
        detectNeutral.addEventListener('click', () => {
          updateEmotionDisplay('neutral');
          updateSongsForEmotion('neutral');
        });
      }
      
      // Start/stop buttons
      const startBtn = document.getElementById('start-btn');
      if (startBtn) {
        startBtn.addEventListener('click', () => {
          startDetection();
        });
      }
      
      const stopBtn = document.getElementById('stop-btn');
      if (stopBtn) {
        stopBtn.addEventListener('click', () => {
          stopDetection();
        });
      }
      
      // Language selector
      const languageSelect = document.getElementById('language-select');
      if (languageSelect) {
        languageSelect.addEventListener('change', () => {
          const emotionText = document.getElementById('emotion-text');
          if (emotionText && emotionText.textContent !== 'none') {
            updateSongsForEmotion(emotionText.textContent);
          }
        });
      }
    }
    
    // Start detection
    function startDetection() {
      const startBtn = document.getElementById('start-btn');
      const stopBtn = document.getElementById('stop-btn');
      if (!startBtn || !stopBtn) return;
      
      startBtn.disabled = true;
      stopBtn.disabled = false;
      
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      if (!video || !canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      // Set canvas size to match video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // Start detection loop
      const detectInterval = setInterval(async () => {
        if (!stopBtn || stopBtn.disabled) {
          clearInterval(detectInterval);
          return;
        }
        
        // Detect emotions
        const detections = await faceapi.detectSingleFace(
          video, 
          new faceapi.TinyFaceDetectorOptions()
        ).withFaceLandmarks().withFaceExpressions();
        
        if (detections) {
          // Draw detection on canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          faceapi.draw.drawDetections(canvas, detections);
          faceapi.draw.drawFaceLandmarks(canvas, detections);
          faceapi.draw.drawFaceExpressions(canvas, detections);
          
          // Get dominant emotion
          const expressions = detections.expressions;
          const emotion = Object.keys(expressions).reduce(
            (a, b) => expressions[a] > expressions[b] ? a : b
          );
          
          // Update UI
          updateEmotionDisplay(emotion);
          updateSongsForEmotion(emotion);
        }
      }, 1000);
      
      // Store interval ID to stop later
      window.detectInterval = detectInterval;
    }
    
    // Stop detection
    function stopDetection() {
      const startBtn = document.getElementById('start-btn');
      const stopBtn = document.getElementById('stop-btn');
      if (!startBtn || !stopBtn) return;
      
      startBtn.disabled = false;
      stopBtn.disabled = true;
      
      // Clear detection interval
      if (window.detectInterval) {
        clearInterval(window.detectInterval);
      }
      
      // Clear canvas
      const canvas = document.getElementById('canvas');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }
    
    // Open song in Spotify app
    function openInSpotify(trackId) {
      // Direct link to the track - this always works
      window.open(`https://open.spotify.com/track/${trackId}`, '_blank');
    }
    
    // Simulate backend API call to Spotify
    async function fetchSpotifyRecommendations(emotion, language) {
      const statusDiv = document.getElementById('status');
      if (!statusDiv) return;
      
      statusDiv.innerHTML = `<div class="loading"></div> Creating ${emotion} cosmic soundscape...`;
      
      // Simulate API call delay
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // Sample music data with REAL Spotify IDs
      const sampleMusicData = {
        happy: [
          { id: '60nZcImufyMA1MKQY3dcCH', name: 'Happy', artist: 'Pharrell Williams', album: 'G I R L', image: 'https://i.scdn.co/image/ab67616d0000b2731c3e0a2f4ab8e3d7a7f3d0c5' },
          { id: '1WkMMavIMc4JZ8cfMmxHkI', name: "Can't Stop the Feeling!", artist: 'Justin Timberlake', album: 'Trolls', image: 'https://i.scdn.co/image/ab67616d0000b273a48964b5d9a3d6968ae3e0de' },
          { id: '6C2Dn1N5zd3Qb1QJqkUa0g', name: 'Uptown Funk', artist: 'Mark Ronson ft. Bruno Mars', album: 'Uptown Special', image: 'https://i.scdn.co/image/ab67616d0000b2733f29a976eea00141514ab756' },
          { id: '3fthfkkvy9av3q3uAGVf7U', name: 'Shake It Off', artist: 'Taylor Swift', album: '1989', image: 'https://i.scdn.co/image/ab67616d0000b273e11a75a2f2ff39cec788a015' }
        ],
        sad: [
          { id: '6QPKYGnAW9QozVz2dSWqRg', name: 'Someone Like You', artist: 'Adele', album: '21', image: 'https://i.scdn.co/image/ab67616d0000b273ba5db46f4b838ef6027e6f96' },
          { id: '2f8G2dL3H8HzRt2Y8V3xqL', name: 'Say Something', artist: 'A Great Big World', album: 'Is There Anybody Out There?', image: 'https://i.scdn.co/image/ab67616d0000b273b7d3410c326df5c5af0179e8' },
          { id: '7tnOc6GV9GA1phPS6vK7VB', name: 'The Scientist', artist: 'Coldplay', album: 'A Rush of Blood to the Head', image: 'https://i.scdn.co/image/ab67616d0000b273de3c04b5fc750b68899b20a9' },
          { id: '6g4b1wZ0KwZ2Q7a6cLpVqg', name: 'Hurt', artist: 'Johnny Cash', album: 'American IV: The Man Comes Around', image: 'https://i.scdn.co/image/ab67616d0000b273f5a99e0a3b9a5a5f5a5a5a5a' }
        ],
        angry: [
          { id: '7a0qD51uR1v8JmIAVcBv7s', name: 'Break Stuff', artist: 'Limp Bizkit', album: 'Significant Other', image: 'https://i.scdn.co/image/ab67616d0000b2734a1a3b5d5a5a5a5a5a5a5a5a' },
          { id: '3aMfUOjLckXwol4tFcJtGl', name: 'Killing In The Name', artist: 'Rage Against The Machine', album: 'Rage Against The Machine', image: 'https://i.scdn.co/image/ab67616d0000b2739c0f9e9c9c9c9c9c9c9c9c9c9' },
          { id: '6LmNUD1q8gREe7zF3bUqFg', name: 'Given Up', artist: 'Linkin Park', album: 'Minutes to Midnight', image: 'https://i.scdn.co/image/ab67616d0000b273c7e6d3a1c7b5c7a5a2a0b3e2' },
          { id: '0tZ3mElWcr74OOhKEiNz1x', name: 'Bulls On Parade', artist: 'Rage Against The Machine', album: 'Evil Empire', image: 'https://i.scdn.co/image/ab67616d0000b2733f3f3f3f3f3f3f3f3f3f3f3f' }
        ],
        neutral: [
          { id: '0VjIjW4GlUZAMYd2vXMi3b', name: 'Blinding Lights', artist: 'The Weeknd', album: 'After Hours', image: 'https://i.scdn.co/image/ab67616d0000b2738863bc11d2aa12b54f5aeb36' },
          { id: '7qiZfU4dY1lWllzX7mPBI3', name: 'Shape of You', artist: 'Ed Sheeran', album: '√∑ (Divide)', image: 'https://i.scdn.co/image/ab67616d0000b273ba5db46f4b838ef6027e6f96' },
          { id: '6UelLqGlWMcVH1E5c4H7lY', name: 'Watermelon Sugar', artist: 'Harry Styles', album: 'Fine Line', image: 'https://i.scdn.co/image/ab67616d0000b2731c3e0a2f4ab8e3d7a7f3d0c5' },
          { id: '0v1x6rN6JHRapa03JElljE', name: 'Dynamite', artist: 'BTS', album: 'Dynamite (DayTime Version)', image: 'https://i.scdn.co/image/ab67616d0000b273a48964b5d9a3d6968ae3e0de' }
        ],
        fearful: [
          { id: '3HjGmIjG3aZ7G1aQ0Nj8X1', name: 'The Sound of Silence', artist: 'Simon & Garfunkel', album: 'Wednesday Morning, 3 A.M.', image: 'https://i.scdn.co/image/ab67616d0000b273b6d4566db0d12894b1b3c5e5' },
          { id: '2iJuuzV8P9Yz0VSurttIV5', name: 'Hurt', artist: 'Nine Inch Nails', album: 'The Downward Spiral', image: 'https://i.scdn.co/image/ab67616d0000b273f5a99e0a3b9a5a5f5a5a5a5a' }
        ],
        disgusted: [
          { id: '0U9TKK9GYryei6Vn45TEdS', name: 'Bad Guy', artist: 'Billie Eilish', album: 'WHEN WE ALL FALL ASLEEP, WHERE DO WE GO?', image: 'https://i.scdn.co/image/ab67616d0000b27350a3147b4edd7701a876c6ce' }
        ],
        surprised: [
          { id: '5sICkBXVmaCQk5aISGR3x1', name: 'Thriller', artist: 'Michael Jackson', album: 'Thriller', image: 'https://i.scdn.co/image/ab67616d0000b273e11a75a2f2ff39cec788a015' }
        ]
      };
      
      return sampleMusicData[emotion] || sampleMusicData.neutral;
    }
    
    // Update songs based on emotion
    async function updateSongsForEmotion(emotion) {
      try {
        const tracks = await fetchSpotifyRecommendations(emotion);
        renderSongList(tracks);
        
        const statusDiv = document.getElementById('status');
        if (statusDiv) {
          statusDiv.innerHTML = `<i class="fab fa-spotify spotify-icon"></i> Found ${tracks.length} cosmic tracks for ${emotion}`;
        }
      } catch (error) {
        console.error('Error fetching Spotify recommendations:', error);
        const statusDiv = document.getElementById('status');
        if (statusDiv) {
          statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${error.message}`;
        }
      }
    }
    
    // Render song list
    function renderSongList(tracks) {
      const songListDiv = document.getElementById('song-list');
      if (!songListDiv) return;
      
      songListDiv.innerHTML = '';
      
      tracks.forEach(track => {
        const trackEl = document.createElement('div');
        trackEl.className = 'track';
        trackEl.setAttribute('data-id', track.id);
        
        trackEl.innerHTML = `
          <img src="${track.image}" alt="${track.name}">
          <div class="track-info">
            <h3>${track.name}</h3>
            <p>${track.artist} ‚Ä¢ ${track.album}</p>
          </div>
          <div class="track-actions">
            <button class="play-btn">
              <i class="fas fa-play"></i>
            </button>
            <button class="favorite-btn">
              <i class="fas fa-heart"></i>
            </button>
          </div>
        `;
        
        songListDiv.appendChild(trackEl);
      });
      
      // Add event listeners to tracks
      document.querySelectorAll('.track').forEach((track) => {
        track.addEventListener('click', (e) => {
          if (!e.target.closest('button')) {
            const trackId = track.getAttribute('data-id');
            openInSpotify(trackId);
          }
        });
      });
      
      // Add event listeners to play buttons
      document.querySelectorAll('.track .play-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const track = btn.closest('.track');
          const trackId = track.getAttribute('data-id');
          openInSpotify(trackId);
        });
      });
      
      // Add event listeners to favorite buttons
      document.querySelectorAll('.track .favorite-btn').forEach((btn, index) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const track = btn.closest('.track');
          const trackId = track.getAttribute('data-id');
          const trackData = tracks.find(t => t.id === trackId);
          if (trackData) {
            addToFavorites(trackData);
            btn.innerHTML = '<i class="fas fa-check"></i>';
            showNotification('Added to favorites!');
            setTimeout(() => {
              btn.innerHTML = '<i class="fas fa-heart"></i>';
            }, 1000);
          }
        });
      });
    }
    
    // Add to favorites
    function addToFavorites(track) {
      const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      
      // Check if already in favorites
      if (!favorites.some(fav => fav.id === track.id)) {
        favorites.push(track);
        localStorage.setItem('favorites', JSON.stringify(favorites));
        renderFavorites();
      }
    }
    
    // Render favorites
    function renderFavorites() {
      const favoritesListDiv = document.getElementById('favorites-list');
      if (!favoritesListDiv) return;
      
      favoritesListDiv.innerHTML = '';
      
      const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      
      if (favorites.length === 0) {
        favoritesListDiv.innerHTML = `
          <div class="status">
            <i class="fas fa-star"></i> No favorites yet. Add some tracks to your stellar collection!
          </div>
        `;
        return;
      }
      
      favorites.forEach(track => {
        const card = document.createElement('div');
        card.className = 'favorite-card';
        card.setAttribute('data-id', track.id);
        
        card.innerHTML = `
          <img src="${track.image}" alt="${track.name}">
          <h3>${track.name}</h3>
          <p>${track.artist}</p>
          <div class="track-actions" style="margin-top: 15px;">
            <button class="play-btn">
              <i class="fas fa-play"></i>
            </button>
            <button class="remove-btn">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        favoritesListDiv.appendChild(card);
      });
      
      // Add event listeners to favorites
      document.querySelectorAll('.favorite-card').forEach((card) => {
        card.addEventListener('click', (e) => {
          if (!e.target.closest('button')) {
            const trackId = card.getAttribute('data-id');
            openInSpotify(trackId);
          }
        });
      });
      
      document.querySelectorAll('.favorite-card .play-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const card = btn.closest('.favorite-card');
          const trackId = card.getAttribute('data-id');
          openInSpotify(trackId);
        });
      });
      
      document.querySelectorAll('.favorite-card .remove-btn').forEach((btn, index) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
          favorites.splice(index, 1);
          localStorage.setItem('favorites', JSON.stringify(favorites));
          renderFavorites();
          showNotification('Removed from favorites!');
        });
      });
    }
    
    // Initialize the app when the page loads
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>